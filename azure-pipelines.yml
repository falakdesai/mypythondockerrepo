trigger:
- master

variables:
  # General Variables
  imageTag: '$(Build.BuildId)' # Using BuildId is better than 'latest' for tracking
  
  # ACR Variables
  acrName: falakacrrepo1
  imageRepository: falakdesai2/pythonpipelinedemo
  
  # Connection Names (MUST match your Service Connections)
  acrConnection: 'MyDockerConnection'  # <-- **UPDATED** to use the new Docker Registry connection
  aksConnection: 'myaksconnection'     # Kubernetes Service Connection name 
  
  # AKS Deployment Variables
  namespace: default
  k8sManifest: azure-aks.yaml

# -------------------------------------------------------
# Stage 1: Build & Push Docker Image to ACR (Using Docker@2)
# -------------------------------------------------------
stages:
- stage: Build
  displayName: 'Build and Push Docker Image'
  jobs:
  - job: BuildJob
    displayName: 'Docker Build and Push'
    pool:
      vmImage: 'ubuntu-latest'
    steps:
    - checkout: self
    
    # Docker@2 task handles secure ACR login, build, and push
    - task: Docker@2
      displayName: 'Build and Push to ACR'
      inputs:
        command: buildAndPush
        # Now referencing the Docker Registry Service Connection
        containerRegistry: $(acrConnection) 
        repository: $(imageRepository)
        tags: |
          $(imageTag)
          latest

# -------------------------------------------------------
# Stage 2: Deploy to AKS
# -------------------------------------------------------
- stage: Deploy
  displayName: 'Deploy to AKS'
  dependsOn: Build
  condition: succeeded()
  jobs:
  - job: DeployJob
    displayName: 'Deploy Application to Cluster'
    pool:
      vmImage: 'ubuntu-latest'
    steps:
    
    # KubernetesManifest@1 for deployments
    - task: KubernetesManifest@1
      displayName: 'Deploy Kubernetes Manifests'
      inputs:
        action: deploy
        kubernetesServiceConnection: $(aksConnection) 
        namespace: $(namespace)
        kubectlVersion: '1.29.x' 
        manifests: |
          $(k8sManifest)
        # Inject the specific image tag built in the previous stage
        containers: |
          $(acrName).azurecr.io/$(imageRepository):$(imageTag)